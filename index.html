<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2575.4">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 20.0px 72.0px; text-align: justify; text-indent: -72.0px; font: 13.3px Helvetica; -webkit-text-stroke: #000000}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times; -webkit-text-stroke: #000000; min-height: 14.0px}
    span.s1 {font-kerning: none}
  </style>
</head>
<body>
<p class="p1"><span class="s1">async function callGeminiAPI(prompt) {</span></p>
<p class="p1"><span class="s1">    modalContent.innerHTML = '';</span></p>
<p class="p1"><span class="s1">    modalLoader.style.display = 'block';</span></p>
<p class="p1"><span class="s1">    showModal();</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">    // This is the new, important part.</span></p>
<p class="p1"><span class="s1">    // We are calling our own secure function, not Google.</span></p>
<p class="p1"><span class="s1">    const secureFunctionUrl = '/.netlify/functions/getAiInsights';</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">    try {</span></p>
<p class="p1"><span class="s1">        const response = await fetch(secureFunctionUrl, {</span></p>
<p class="p1"><span class="s1">            method: 'POST',</span></p>
<p class="p1"><span class="s1">            body: JSON.stringify({ prompt: prompt }) // Send the prompt to our secure function</span></p>
<p class="p1"><span class="s1">        });</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">        if (!response.ok) {</span></p>
<p class="p1"><span class="s1">            throw new Error(`Function Error: ${response.statusText}`);</span></p>
<p class="p1"><span class="s1">        }</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">        const result = await response.json();</span></p>
<p class="p1"><span class="s1">        </span></p>
<p class="p1"><span class="s1">        if (result.candidates &amp;&amp; result.candidates.length &gt; 0 &amp;&amp;</span></p>
<p class="p1"><span class="s1">            result.candidates[0].content &amp;&amp; result.candidates[0].content.parts &amp;&amp;</span></p>
<p class="p1"><span class="s1">            result.candidates[0].content.parts.length &gt; 0) {</span></p>
<p class="p1"><span class="s1">            </span></p>
<p class="p1"><span class="s1">            let text = result.candidates[0].content.parts[0].text;</span></p>
<p class="p1"><span class="s1">            text = text.replace(/\*\*(.*?)\*\*/g, '&lt;h3&gt;$1&lt;/h3&gt;');</span></p>
<p class="p1"><span class="s1">            text = text.replace(/\*/g, '&lt;li&gt;');</span></p>
<p class="p1"><span class="s1">            </span></p>
<p class="p1"><span class="s1">            modalContent.innerHTML = text;</span></p>
<p class="p1"><span class="s1">        } else {</span></p>
<p class="p1"><span class="s1">            modalContent.textContent = 'Sorry, the AI could not generate a response. Please try again later.';</span></p>
<p class="p1"><span class="s1">        }</span></p>
<p class="p1"><span class="s1">    } catch (error) {</span></p>
<p class="p1"><span class="s1">        modalContent.textContent = 'An error occurred while fetching insights. Please check your connection and try again.';</span></p>
<p class="p1"><span class="s1">    } finally {</span></p>
<p class="p1"><span class="s1">        modalLoader.style.display = 'none';</span></p>
<p class="p1"><span class="s1">    }</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
</body>
</html>
